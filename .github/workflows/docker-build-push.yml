name: Build and Push Docker Images

on:
     push:
          branches: [main]
     pull_request:
          branches: [main]

env:
     DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
     DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}

jobs:
     build-and-push:
          runs-on: ubuntu-latest

          strategy:
               matrix:
                    include:
                         - service: vg-ms-organizations
                           image: prs_microservices-vg-ms-organizations
                         - service: vg-ms-users
                           image: prs_microservices-vg-ms-users
                         - service: vg-ms-notifications
                           image: prs_microservices-vg-ms-notifications
                         - service: vg-ms-authentication
                           image: prs_microservices-vg-ms-authentication
                         - service: vg-ms-gateway
                           image: prs_microservices-vg-ms-gateway
                         - service: vg-ms-distribution
                           image: prs_microservices-vg-ms-distribution
                         - service: vg-ms-claims
                           image: prs_microservices-vg-ms-claims
                         - service: vg-ms-infrastructure
                           image: prs_microservices-vg-ms-infrastructure
                         - service: vg-ms-commercial
                           image: prs_microservices-vg-ms-commercial
                         - service: vg-ms-inventory-purchases
                           image: prs_microservices-vg-ms-inventory-purchases
                         - service: Microservicio-main
                           image: prs_microservices-vg-ms-water-quality
                         - service: vg-web-sistemaJass
                           image: prs_microservices-vg-web-sistemajass

          steps:
               - name: Checkout repository
                 uses: actions/checkout@v4

               - name: Set up Docker Buildx
                 uses: docker/setup-buildx-action@v3

               - name: Login to Docker Hub
                 uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}

               - name: Build and push ${{ matrix.service }}
                 uses: docker/build-push-action@v5
                 with:
                      context: ./${{ matrix.service }}
                      file: ./${{ matrix.service }}/Dockerfile
                      push: ${{ github.event_name == 'push' }}
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image }}:latest
                           ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image }}:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max

               - name: Image digest
                 run: echo "Image pushed - ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image }}:latest"
