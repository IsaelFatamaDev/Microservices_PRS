name: Build Changed Services

on:
     push:
          branches: [main]
          paths:
               - "vg-ms-*/**"
               - ".github/workflows/docker-build-changed.yml"

jobs:
     detect-changes:
          runs-on: ubuntu-latest
          outputs:
               organizations: ${{ steps.filter.outputs.organizations }}
               users: ${{ steps.filter.outputs.users }}
               notifications: ${{ steps.filter.outputs.notifications }}
               authentication: ${{ steps.filter.outputs.authentication }}
               gateway: ${{ steps.filter.outputs.gateway }}
               distribution: ${{ steps.filter.outputs.distribution }}
          steps:
               - uses: actions/checkout@v4
               - uses: dorny/paths-filter@v3
                 id: filter
                 with:
                      filters: |
                           organizations:
                             - 'vg-ms-organizations/**'
                           users:
                             - 'vg-ms-users/**'
                           notifications:
                             - 'vg-ms-notifications/**'
                           authentication:
                             - 'vg-ms-authentication/**'
                           gateway:
                             - 'vg-ms-gateway/**'
                           distribution:
                             - 'vg-ms-distribution/**'

     build-organizations:
          needs: detect-changes
          if: needs.detect-changes.outputs.organizations == 'true'
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4
               - uses: docker/setup-buildx-action@v3
               - uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}
               - uses: docker/build-push-action@v5
                 with:
                      context: ./vg-ms-organizations
                      push: true
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-organizations:latest
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-organizations:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max

     build-users:
          needs: detect-changes
          if: needs.detect-changes.outputs.users == 'true'
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4
               - uses: docker/setup-buildx-action@v3
               - uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}
               - uses: docker/build-push-action@v5
                 with:
                      context: ./vg-ms-users
                      push: true
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-users:latest
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-users:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max

     build-notifications:
          needs: detect-changes
          if: needs.detect-changes.outputs.notifications == 'true'
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4
               - uses: docker/setup-buildx-action@v3
               - uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}
               - uses: docker/build-push-action@v5
                 with:
                      context: ./vg-ms-notifications
                      push: true
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-notifications:latest
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-notifications:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max

     build-authentication:
          needs: detect-changes
          if: needs.detect-changes.outputs.authentication == 'true'
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4
               - uses: docker/setup-buildx-action@v3
               - uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}
               - uses: docker/build-push-action@v5
                 with:
                      context: ./vg-ms-authentication
                      push: true
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-authentication:latest
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-authentication:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max

     build-gateway:
          needs: detect-changes
          if: needs.detect-changes.outputs.gateway == 'true'
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4
               - uses: docker/setup-buildx-action@v3
               - uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}
               - uses: docker/build-push-action@v5
                 with:
                      context: ./vg-ms-gateway
                      push: true
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-gateway:latest
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-gateway:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max

     build-distribution:
          needs: detect-changes
          if: needs.detect-changes.outputs.distribution == 'true'
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4
               - uses: docker/setup-buildx-action@v3
               - uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_TOKEN }}
               - uses: docker/build-push-action@v5
                 with:
                      context: ./vg-ms-distribution
                      push: true
                      tags: |
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-distribution:latest
                           ${{ secrets.DOCKER_USERNAME }}/prs_microservices-vg-ms-distribution:${{ github.sha }}
                      cache-from: type=gha
                      cache-to: type=gha,mode=max
